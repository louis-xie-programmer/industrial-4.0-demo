# PCB æ™ºèƒ½å·¥å‚è°ƒåº¦ç³»ç»Ÿ (Go å®æˆ˜é¡¹ç›®)

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Golang** æ„å»ºçš„å·¥ä¸š 4.0 æ™ºèƒ½ç”Ÿäº§è°ƒåº¦ç³»ç»ŸåŸå‹ã€‚å®ƒä»¥ **PCBï¼ˆå°åˆ¶ç”µè·¯æ¿ï¼‰åˆ¶é€ ** ä¸ºä¸šåŠ¡åœºæ™¯ï¼Œæ¨¡æ‹Ÿäº†ä¸€ä¸ªé«˜åº¦è‡ªåŠ¨åŒ–çš„æ™ºèƒ½å·¥å‚ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Go è¯­è¨€è§£å†³å¤æ‚çš„å·¥ä¸šè°ƒåº¦é—®é¢˜ã€‚

æœ¬é¡¹ç›®æ—¨åœ¨æ¼”ç¤ºç°ä»£åç«¯æ¶æ„æ¨¡å¼åœ¨å®ä½“äº§ä¸šä¸­çš„åº”ç”¨ï¼Œæ¶µç›–äº†ä»**å¹¶å‘æ§åˆ¶**ã€**çŠ¶æ€ç®¡ç†**åˆ°**å¾®æœåŠ¡é€šä¿¡**çš„å…¨æ ˆæŠ€æœ¯ç‚¹ã€‚

ç»“åˆå¾®ä¿¡å…¬ä¼—å·åšæ–‡ï¼Œå¯å¿«é€Ÿäº†è§£æœ¬ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½å’Œå®ç°åŸç†, åç»­ä¼šæŒç»­æ›´æ–°ï¼Œæ¬¢è¿å¤§å®¶æ‰«ç å…³æ³¨"ä»£ç æ‰³æ‰‹"å…¬ä¼—å·ï¼Œè·å–æ›´å¤šæŠ€æœ¯äº¤æµä¿¡æ¯ã€‚

![wx.jpg](wx.jpg)

## âœ¨ æ ¸å¿ƒç‰¹æ€§

*   **ğŸ­ çœŸå®ä¸šåŠ¡æ¨¡æ‹Ÿ**
    *   **PCB åˆ¶é€ æµç¨‹**: å®Œæ•´æ¨¡æ‹Ÿäº†ä» CAM æ–‡ä»¶å¤„ç†ã€é’»å­”ã€èš€åˆ»ã€å±‚å‹åˆ° AOI æ£€æµ‹ã€ç”µæµ‹ã€åŒ…è£…çš„å…¨å¥—å·¥è‰ºã€‚
    *   **å¤šç»´è®¢å•å¤„ç†**: æ”¯æŒ**åŒé¢æ¿**ã€**å¤šå±‚æ¿**ã€**åŠ æ€¥æ‰“æ ·**ç­‰ä¸åŒç±»å‹çš„è®¢å•ï¼Œå¹¶åŒ¹é…ä¸åŒçš„ç”Ÿäº§è·¯å¾„ã€‚

*   **ğŸ§  æ™ºèƒ½è°ƒåº¦æ ¸å¿ƒ**
    *   **ä¼˜å…ˆçº§é˜Ÿåˆ— (Priority Queue)**: æ”¯æŒ VIP è®¢å•æ’é˜Ÿï¼Œç¡®ä¿é«˜ä»·å€¼ä»»åŠ¡ä¼˜å…ˆå¤„ç†ã€‚
    *   **åŠ¨æ€èµ„æºè°ƒåº¦**: åŸºäºä¿¡å·é‡ (Semaphore) çš„èµ„æºæ± ç®¡ç†ï¼Œè§£å†³å…³é”®è®¾å¤‡ï¼ˆå¦‚é£é’ˆæµ‹è¯•æœºï¼‰çš„èµ„æºäº‰æŠ¢é—®é¢˜ã€‚

*   **ğŸ”„ å¥å£®çš„æµç¨‹æ§åˆ¶**
    *   **FSM æœ‰é™çŠ¶æ€æœº**: ç²¾å‡†ç®¡ç†å·¥ä»¶ç”Ÿå‘½å‘¨æœŸ (`Created` -> `Processing` -> `Completed` / `Failed`)ã€‚
    *   **Saga äº‹åŠ¡æ¨¡å¼**: å®ç°é•¿æµç¨‹çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæ”¯æŒå¤±è´¥åçš„è‡ªåŠ¨å›æ»šä¸è¡¥å¿ (Compensating Transaction)ã€‚
    *   **è§„åˆ™å¼•æ“ (Rule Engine)**: é›†æˆ `expr` å¼•æ“ï¼Œæ”¯æŒåŸºäºå·¥ä»¶å±æ€§ï¼ˆå¦‚ `layers > 2`ï¼‰çš„åŠ¨æ€å·¥è‰ºè·¯å¾„å†³ç­–ã€‚
    *   **å¹¶è¡Œå·¥åº**: æ”¯æŒå¤šå·¥ç«™å¹¶è¡Œä½œä¸šï¼ˆå¦‚é˜»ç„Šä¸ä¸å°åŒæ—¶è¿›è¡Œï¼‰ï¼Œæœ€å¤§åŒ–ç”Ÿäº§æ•ˆç‡ã€‚

*   **ğŸ›¡ï¸ é«˜å¯é æ€§ä¸å¯è§‚æµ‹æ€§**
    *   **WAL (Write-Ahead Logging)**: é¢„å†™æ—¥å¿—æŒä¹…åŒ–ï¼Œç¡®ä¿ç³»ç»Ÿå´©æºƒåä»»åŠ¡ä¸ä¸¢å¤±ï¼Œå¯åŠ¨è‡ªåŠ¨æ¢å¤ã€‚
    *   **ä¼˜é›…åœæœº (Graceful Shutdown)**: ç¡®ä¿åœ¨æœåŠ¡åœæ­¢æ—¶ï¼Œæ‰€æœ‰æ­£åœ¨å¤„ç†çš„ä»»åŠ¡éƒ½èƒ½å®‰å…¨å®Œæˆã€‚
    *   **åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª**: é€šè¿‡ `Context` å’Œ `HTTP Header` ä¼ é€’ `Trace ID`ï¼Œä¸²è”èµ·è·¨æœåŠ¡çš„æ‰€æœ‰æ—¥å¿—ã€‚
    *   **Prometheus Metrics**: æš´éœ²å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆé˜Ÿåˆ—é•¿åº¦ã€å¤„ç†è€—æ—¶ã€æˆåŠŸç‡ï¼‰ã€‚
    *   **ç»“æ„åŒ–æ—¥å¿—**: ä½¿ç”¨ `slog` è¾“å‡º JSON æ ¼å¼æ—¥å¿—ï¼Œä¾¿äºæ—¥å¿—èšåˆä¸åˆ†æã€‚

*   **ğŸŒ ç°ä»£æ¶æ„**
    *   **äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven)**: åŸºäºå†…éƒ¨ Event Bus è§£è€¦æ ¸å¿ƒå¼•æ“ä¸å‰¯ä½œç”¨é€»è¾‘ï¼ˆUI æ›´æ–°ã€ç›‘æ§ï¼‰ã€‚
    *   **å¾®æœåŠ¡é€šä¿¡**: æ¨¡æ‹Ÿè¿œç¨‹å·¥ç«™ (AOI æ£€æµ‹)ï¼Œé€šè¿‡ HTTP/JSON è¿›è¡Œè·¨æœåŠ¡è°ƒç”¨ã€‚
    *   **å®æ—¶å¯è§†åŒ–**: å†…ç½® WebSocket æœåŠ¡å™¨å’Œçº¯åŸç”Ÿ HTML/JS å‰ç«¯ï¼Œå®æ—¶å±•ç¤ºå·¥å‚æµæ°´çº¿çŠ¶æ€ã€‚
    *   **é…ç½®å¤–éƒ¨åŒ– (Viper)**: å°†æ‰€æœ‰é…ç½®ç§»è‡³ `config.yaml`ï¼Œå®ç°é…ç½®ä¸ä»£ç åˆ†ç¦»ã€‚
    *   **å®¹å™¨åŒ–éƒ¨ç½²**: æä¾› `Dockerfile` å’Œ `docker-compose.yml`ï¼Œä¸€é”®å¯åŠ¨æ•´ä¸ªåº”ç”¨ç”Ÿæ€ï¼ˆåŒ…å«ç›‘æ§ï¼‰ã€‚
    *   **é›†æˆæµ‹è¯•**: åŒ…å«ç«¯åˆ°ç«¯çš„é›†æˆæµ‹è¯•ï¼Œè¦†ç›–æˆåŠŸè·¯å¾„å’Œ Saga å›æ»šè·¯å¾„ï¼Œä¿è¯ä»£ç è´¨é‡ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

*   Docker & Docker Compose

### ä½¿ç”¨ Docker Compose (æ¨è)

ä¸€é”®å¯åŠ¨æ•´ä¸ªç³»ç»Ÿï¼ˆåŒ…å«ä¸»è°ƒåº¦å™¨ã€è¿œç¨‹ AOI æœåŠ¡ã€Prometheus å’Œ Grafanaï¼‰ï¼š

```bash
docker-compose up --build
```

å¯åŠ¨æˆåŠŸåï¼Œæ‰“å¼€æµè§ˆå™¨è®¿é—®ä»¥ä¸‹åœ°å€ï¼š

*   **å®æ—¶ç›‘æ§å¤§å±**: **http://localhost:8080**
*   **Grafana ä»ªè¡¨ç›˜**: **http://localhost:3000** (ç”¨æˆ·å/å¯†ç : `admin`/`admin`)
*   **Prometheus UI**: **http://localhost:9091**

## ğŸ§ª è¿è¡Œæµ‹è¯•

æœ¬é¡¹ç›®åŒ…å«é›†æˆæµ‹è¯•ï¼Œè¦†ç›–æ ¸å¿ƒä¸šåŠ¡æµç¨‹ã€‚

```bash
go test ./test
```

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
.
â”œâ”€â”€ cmd
â”‚   â”œâ”€â”€ orchestrator      # ä¸»è°ƒåº¦ç¨‹åºå…¥å£
â”‚   â””â”€â”€ station-server    # æ¨¡æ‹Ÿè¿œç¨‹å·¥ç«™çš„å¾®æœåŠ¡
â”œâ”€â”€ internal
â”‚   â”œâ”€â”€ config            # é…ç½®ç®¡ç† (Viper)
â”‚   â”œâ”€â”€ engine            # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (Workflow, Scheduler)
â”‚   â”œâ”€â”€ event             # äº‹ä»¶æ€»çº¿ (Event Bus)
â”‚   â”œâ”€â”€ fsm               # æœ‰é™çŠ¶æ€æœº
â”‚   â”œâ”€â”€ handlers          # äº‹ä»¶å¤„ç†å™¨ (Metrics, UI, Log)
â”‚   â”œâ”€â”€ metrics           # Prometheus æŒ‡æ ‡å®šä¹‰
â”‚   â”œâ”€â”€ persistence       # WAL æŒä¹…åŒ–å®ç°
â”‚   â”œâ”€â”€ station           # å·¥ç«™æ¥å£ä¸å®ç° (Local, Remote)
â”‚   â”œâ”€â”€ types             # é¢†åŸŸæ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ util              # å·¥å…·å‡½æ•° (Trace ID)
â”‚   â””â”€â”€ web               # WebSocket Hub ä¸çŠ¶æ€è¿½è¸ª
â”œâ”€â”€ monitoring            # Prometheus å’Œ Grafana é…ç½®æ–‡ä»¶
â”œâ”€â”€ test                  # é›†æˆæµ‹è¯•
â”œâ”€â”€ web
â”‚   â””â”€â”€ static            # å‰ç«¯é™æ€èµ„æº (HTML/CSS/JS)
â”œâ”€â”€ config.yaml           # å¤–éƒ¨åŒ–é…ç½®æ–‡ä»¶
â”œâ”€â”€ Dockerfile.*          # Docker æ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml    # å®¹å™¨ç¼–æ’é…ç½®
â””â”€â”€ tasks.wal             # ä»»åŠ¡æŒä¹…åŒ–æ—¥å¿— (è‡ªåŠ¨ç”Ÿæˆ)
```

## ğŸ”Œ API æ¥å£

### æäº¤ä»»åŠ¡

```bash
POST /api/tasks
Content-Type: application/json

{
    "id": "PCB_Custom_001",
    "type": "PCB_MULTILAYER",
    "priority": 1,
    "attrs": {
        "layers": 6
    }
}
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

*   **Language**: Go
*   **Configuration**: `github.com/spf13/viper`
*   **Web Framework**: Standard `net/http`
*   **WebSocket**: `github.com/gorilla/websocket`
*   **Rule Engine**: `github.com/antonmedv/expr`
*   **Metrics**: `github.com/prometheus/client_golang`
*   **Logging**: `log/slog` (Stdlib)
*   **Deployment**: Docker, Docker Compose

---

**Talk is cheap, show me the code.**
```
