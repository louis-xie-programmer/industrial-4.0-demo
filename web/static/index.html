<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PCB 智能工厂 - 实时监控</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1e1e2f; color: #e0e0e0; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #00e676; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; }

        #factory-floor {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            padding-left: 100px; /* Space for queue */
        }

        .station {
            background-color: #2c2c3e;
            border: 1px solid #3f3f5f;
            border-radius: 12px;
            padding: 15px;
            width: 140px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .station:hover { transform: translateY(-5px); border-color: #00e676; }

        .station-name {
            font-size: 14px;
            font-weight: bold;
            color: #9fa8da;
            margin-bottom: 10px;
            text-align: center;
        }

        .product-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            width: 100%;
        }

        .product {
            width: 24px;
            height: 24px;
            border-radius: 4px; /* PCB style square with rounded corners */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Status Colors */
        .status-processing { background-color: #29b6f6; box-shadow: 0 0 8px #29b6f6; }
        .status-completed { background-color: #00e676; }
        .status-failed { background-color: #ff5252; }
        .status-queued { background-color: #78909c; }
        .status-compensated { background-color: #ffa726; }

        /* Special Stations */
        #station-STATION_AOI { border-color: #ab47bc; } /* Remote */
        #station-STATION_E_TEST { border-color: #ff7043; } /* Bottleneck */

        #queue {
            display: flex;
            flex-wrap: wrap;
            max-width: 1200px;
            margin: 20px auto;
            position: relative;
        }
    </style>
</head>
<body>

<h1>PCB 智能工厂 - 生产实时监控</h1>
<div id="queue" class="station">
    <div class="station-name">待产队列</div>
    <div class="product-container" id="station-QUEUED"></div>
</div>
<div id="factory-floor">


    <!-- Process Flow -->
    <div class="station">
        <div class="station-name">CAM 工程</div>
        <div class="product-container" id="station-STATION_CAM"></div>
    </div>
    <div class="station">
        <div class="station-name">层压 (多层)</div>
        <div class="product-container" id="station-STATION_LAMI"></div>
    </div>
    <div class="station">
        <div class="station-name">数控钻孔</div>
        <div class="product-container" id="station-STATION_DRILL"></div>
    </div>
    <div class="station">
        <div class="station-name">线路蚀刻</div>
        <div class="product-container" id="station-STATION_ETCH"></div>
    </div>
    <div class="station">
        <div class="station-name">阻焊涂布</div>
        <div class="product-container" id="station-STATION_MASK"></div>
    </div>
    <div class="station">
        <div class="station-name">字符丝印</div>
        <div class="product-container" id="station-STATION_SILK"></div>
    </div>
    <div class="station" id="station-div-AOI">
        <div class="station-name">AOI 检测 (远程)</div>
        <div class="product-container" id="station-STATION_AOI"></div>
    </div>
    <div class="station" id="station-div-ETEST">
        <div class="station-name">飞针电测 (瓶颈)</div>
        <div class="product-container" id="station-STATION_E_TEST"></div>
    </div>
    <div class="station">
        <div class="station-name">成品包装</div>
        <div class="product-container" id="station-STATION_PACK"></div>
    </div>
    <div class="station">
        <div class="station-name">已出货</div>
        <div class="product-container" id="station-EXIT_STATION"></div>
    </div>
</div>

<script>
    const stationMapping = {
        "STATION_CAM": "station-STATION_CAM",
        "STATION_LAMI": "station-STATION_LAMI",
        "STATION_DRILL": "station-STATION_DRILL",
        "STATION_ETCH": "station-STATION_ETCH",
        "STATION_MASK": "station-STATION_MASK",
        "STATION_SILK": "station-STATION_SILK",
        "STATION_AOI": "station-STATION_AOI",
        "STATION_E_TEST": "station-STATION_E_TEST",
        "STATION_PACK": "station-STATION_PACK",
        "EXIT_STATION": "station-EXIT_STATION",
        "QUEUED": "station-QUEUED",
        "": "station-QUEUED"
    };

    function updateUI(state) {
        document.querySelectorAll('.product-container').forEach(c => c.innerHTML = '');
        if (!state.products) return;

        for (const id in state.products) {
            const product = state.products[id];

            let stationId = stationMapping[product.station] || 'station-QUEUED';
            if (product.status === 'COMPLETED') stationId = 'station-EXIT_STATION';

            // Filter out failed/compensated from main view to keep it clean
            if (product.status === 'FAILED' || product.status === 'COMPENSATED') continue;

            const container = document.getElementById(stationId);
            if (container) {
                const productDiv = document.createElement('div');
                productDiv.id = `product-${product.id}`;
                productDiv.className = 'product';
                productDiv.classList.add(`status-${product.status.toLowerCase()}`);

                let title = `ID: ${product.id}\nType: ${product.type}\nPrio: ${product.priority}`;
                if (product.attrs) title += `\nAttrs: ${JSON.stringify(product.attrs)}`;
                productDiv.title = title;

                // Display logic
                let text = '';
                if (product.type.includes('PROTO')) text = 'P';
                else if (product.type.includes('MULTI')) text = 'M';
                else text = 'D';

                if (product.priority > 0) text += '!';
                productDiv.innerText = text;

                container.appendChild(productDiv);
            }
        }
    }

    function connect() {
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onopen = () => {
            console.log('Connected');
            fetch('/api/state').then(r => r.json()).then(updateUI);
        };
        ws.onmessage = (e) => updateUI(JSON.parse(e.data));
        ws.onclose = () => setTimeout(connect, 1000);
    }

    connect();
</script>

</body>
</html>
